@page "/products/{CategoryId:long}"
@using HardwareStore.Domain.Services
@using HardwareStore.Domain.Models
@using HardwareStore.Client.Data

@inject IProductService ProductService;
@inject NavigationManager NavigationManager;
@inject IUserProductsService UserProductsService;
@inject ISnackbar Snackbar;

@if (!_isLoaded)
{
    <MudProgressLinear Color="Color.Primary"/>
}
@if (_isLoaded && _products.Count == 0)
{
    <h1>Товары не найдены</h1>
}
<MudGrid Spacing="1" Class="d-flex" Justify="Justify.SpaceAround">
    @foreach (Product product in _products)
    {
        <MudItem xs="12" md="9" lg="12">
            <MudPaper Class="pa-5 d-flex justify-start align-center">
                <MudContainer Class="d-flex align-center justify-space-around">
                    @if (product.Images.Count == 0)
                    {
                        <MudImage Class="mr-5" Height="200" Width="200">
                            <MudSkeleton Animation="Animation.Pulse" SkeletonType="SkeletonType.Circle" Height="200px" Width="200"/>
                        </MudImage>
                    }
                    @foreach (var image in product.Images.Take(1))
                    {
                        var base64ImageString = Convert.ToBase64String(image.Source);
                        var convertedSource = $"data:image;base64,{base64ImageString}";
                        <MudImage Style="width: 35%; height: 35%; min-height: 100px; min-width: 100px" Src="@convertedSource" Class="mr-5"/>
                    }
                    <MudHidden Breakpoint="Breakpoint.Xs">
                        <MudStack Class="d-flex flex-column pa-0" Spacing="2">
                            <MudText Color="Color.Info" Align="Align.Start" Class="d-flex">
                                <b>Характеристики:</b>
                            </MudText>
                            @foreach (Characteristic characteristic in product.Characteristics.Take(4))
                            {
                                <MudText>
                                    <b>@characteristic.Name: </b>@characteristic.Value
                                </MudText>
                            }
                        </MudStack>
                    </MudHidden>
                    <MudContainer Class="d-flex flex-column justify-space-between pl-5">
                        <MudText Align="Align.Start" Color="Color.Info">
                            <b>Название категории</b>
                            @product.Category.Name
                        </MudText>
                        <MudText Align="Align.Start" Class="mt-1 mb-2"><b>Наименование:</b> @product.Name</MudText>
                        <MudText Align="Align.Start" Class="mb-2">Код: @product.Code</MudText>
                        <MudStack Row="true" Spacing="1" Class="mb-5">
                            <MudText Color="Color.Secondary">
                                <b>Стоимость:</b>
                            </MudText>
                            <MudText>
                                @product.Cost
                            </MudText>
                        </MudStack>
                        <MudStack Row="true">
                            <MudTooltip Text="В корзину">
                                <MudFab OnClick="async() => await AddToCart(product)" Color="Color.Success" Icon="@Icons.Material.Filled.ShoppingCart"/>
                            </MudTooltip>
                            <MudTooltip Text="В избранное">
                                <MudFab OnClick="async () => await AddToFavorite(product)" Color="Color.Error" Icon="@Icons.Material.Filled.Favorite"/>
                            </MudTooltip>
                            <MudTooltip Text="Подробнее">
                                <MudFab OnClick="() => OpenProductPage(product.Id)" Color="Color.Primary" Icon="@Icons.Material.Filled.MoreHoriz"/>
                            </MudTooltip>
                        </MudStack>
                    </MudContainer>
                </MudContainer>
            </MudPaper>
        </MudItem>
    }
</MudGrid>

@code {

    [Parameter]
    public long CategoryId { get; set; } = 1;
    private List<Product> _products = new();

    private bool _isLoaded;

    protected override async Task OnInitializedAsync()
    {
        _products = (await ProductService.GetProducts(CategoryId)).ToList();
        _isLoaded = true;
        await base.OnInitializedAsync();
    }

    private void OpenProductPage(long id)
    {
        NavigationManager.NavigateTo($"/product/{id}");
    }
    
    private async Task AddToCart(Product? product)
    {
        if (AppState.AuthorizedUser is null)
        {
            Snackbar.Add("Для добавления товара в корзину, необходимо авторизироваться", Severity.Error);
            return;
        }
        if (product is null)
            return;
        var res = await UserProductsService.AddToCartAsync(product.Id,AppState.AuthorizedUser.Id);
        if (res.Success)
        {
            Snackbar.Add($"Товар {product.Name} успешно добавлен в корзину", Severity.Success);
            return;
        }
        Snackbar.Add(res.Message, Severity.Info);
    }

    private async Task AddToFavorite(Product? product)
    {
        if (AppState.AuthorizedUser is null)
        {
            Snackbar.Add("Для добавления товара в избранное, необходимо авторизироваться", Severity.Error);
            return;
        }
        if (product is null)
            return;
        var res = await UserProductsService.AddToFavoriteAsync(product.Id,AppState.AuthorizedUser.Id);
        if (res.Success)
        {
            Snackbar.Add($"Товар {product.Name} успешно добавлен в избранное", Severity.Success);
            return;
        }
        Snackbar.Add(res.Message, Severity.Info);
    }
}